<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Texas Congressional District Swingometer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- D3 for GeoJSON + projections -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }
    #tooltip {
      position: fixed;
      z-index: 50;
      pointer-events: none;
      max-width: 260px;
    }
    #tooltip.hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-50">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-slate-800 bg-slate-900/70 backdrop-blur">
      <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
            Texas Congressional District Swingometer
          </h1>
          <p class="text-xs sm:text-sm text-slate-400 mt-1">
            Adjust statewide D/R support and see how districts tip.
          </p>
        </div>
        <div class="flex items-center gap-3 text-[0.7rem] text-slate-400">
          <span class="inline-flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-blue-500/80 border border-blue-300/70"></span>
            Dem lead
          </span>
          <span class="inline-flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-red-500/80 border border-red-300/70"></span>
            GOP lead
          </span>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
        <!-- Controls + Map -->
        <div class="grid lg:grid-cols-3 gap-6">
          <!-- Controls -->
          <section class="bg-slate-900/70 border border-slate-800 rounded-2xl shadow-xl p-5 space-y-4">
            <h2 class="text-sm font-semibold text-slate-100 tracking-tight">
              Statewide inputs
            </h2>
            <p class="text-xs text-slate-400">
              These are statewide vote shares. Each district’s response is shaped by its D/R ratio.
            </p>

            <div class="space-y-3 mt-2">
              <div>
                <label for="demInput" class="flex justify-between text-xs text-slate-300 mb-1">
                  <span>Democratic vote share</span>
                  <span id="demLabel" class="font-semibold text-blue-300">50.0%</span>
                </label>
                <input
                  id="demInput"
                  type="range"
                  min="0"
                  max="100"
                  step="0.1"
                  value="50"
                  class="w-full"
                />
              </div>

              <div>
                <label for="repInput" class="flex justify-between text-xs text-slate-300 mb-1">
                  <span>Republican vote share</span>
                  <span id="repLabel" class="font-semibold text-red-300">50.0%</span>
                </label>
                <input
                  id="repInput"
                  type="range"
                  min="0"
                  max="100"
                  step="0.1"
                  value="50"
                  class="w-full"
                />
                <p class="mt-1 text-[0.65rem] text-slate-500">
                  Sliders are always normalized so D + R = 100.
                </p>
              </div>
            </div>

            <div class="flex items-center gap-2 mt-3">
              <button
                id="resetBtn"
                class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-800 hover:bg-slate-700 border border-slate-700"
              >
                Reset to 50–50
              </button>
              <span class="text-[0.7rem] text-slate-400">
                Colors update automatically as you move the sliders.
              </span>
            </div>

            <div class="mt-4 text-xs text-slate-300 space-y-1">
              <div id="statewideSummary" class="font-medium text-slate-100">
                Average across districts: D 50.0% – R 50.0%
              </div>
              <div class="text-slate-500">
                District intensity reflects margin: narrow races are pale, blowouts are saturated.
              </div>
            </div>
          </section>

          <!-- Map -->
          <section class="lg:col-span-2 bg-slate-900/70 border border-slate-800 rounded-2xl shadow-xl">
            <div class="px-5 pt-4 pb-3 flex items-center justify-between gap-2">
              <div>
                <h2 class="text-sm font-semibold text-slate-100 tracking-tight">
                  Texas districts map
                </h2>
                <p class="text-xs text-slate-400">
                  Hover a district for details.
                </p>
              </div>
            </div>
            <div class="bg-slate-950/80 border-t border-slate-800">
              <div class="aspect-[16/9] w-full flex items-center justify-center">
                <svg
                  id="texasMapSVG"
                  class="w-full h-full"
                  viewBox="0 0 1000 600"
                  preserveAspectRatio="xMidYMid meet"
                ></svg>
              </div>
            </div>
          </section>
        </div>

        <!-- District table -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-2xl shadow-xl">
          <div class="px-5 pt-4 pb-3 flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-slate-100 tracking-tight">
                District-level results
              </h2>
              <p class="text-xs text-slate-400">
                Based on current statewide inputs and fixed district D/R ratios.
              </p>
            </div>
          </div>
          <div class="border-t border-slate-800 max-h-[420px] overflow-y-auto">
            <table class="min-w-full text-xs text-slate-200">
              <thead class="sticky top-0 bg-slate-900/95 backdrop-blur border-b border-slate-800">
                <tr>
                  <th class="px-3 py-2 text-left text-slate-400 font-medium">District</th>
                  <th class="px-3 py-2 text-right text-blue-300 font-medium">D %</th>
                  <th class="px-3 py-2 text-right text-red-300 font-medium">R %</th>
                  <th class="px-3 py-2 text-center text-slate-400 font-medium">Winner</th>
                  <th class="px-3 py-2 text-right text-slate-400 font-medium">Margin</th>
                </tr>
              </thead>
              <tbody id="districtTableBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Tooltip -->
  <div
    id="tooltip"
    class="hidden bg-slate-900/95 border border-slate-700 text-slate-100 text-xs rounded-lg shadow-xl px-3 py-2"
  ></div>

  <script>
    // --- District D/R ratios (your data) ---
    const districtRatios = {
      1:  { D: 0.59, R: 1.35 },
      2:  { D: 0.86, R: 1.12 },
      3:  { D: 0.87, R: 1.09 },
      4:  { D: 0.87, R: 1.11 },
      5:  { D: 0.90, R: 1.09 },
      6:  { D: 0.87, R: 1.11 },
      7:  { D: 1.41, R: 0.65 },
      8:  { D: 0.85, R: 1.13 },
      9:  { D: 0.95, R: 1.05 },
      10: { D: 0.90, R: 1.08 },
      11: { D: 0.75, R: 1.21 },
      12: { D: 0.88, R: 1.10 },
      13: { D: 0.60, R: 1.33 },
      14: { D: 0.85, R: 1.13 },
      15: { D: 1.00, R: 1.01 },
      16: { D: 1.40, R: 0.67 },
      17: { D: 0.90, R: 1.08 },
      18: { D: 1.78, R: 0.36 },
      19: { D: 0.56, R: 1.37 },
      20: { D: 1.49, R: 0.59 },
      21: { D: 0.89, R: 1.09 },
      22: { D: 0.88, R: 1.09 },
      23: { D: 0.99, R: 1.01 },
      24: { D: 0.95, R: 1.04 },
      25: { D: 0.89, R: 1.10 },
      26: { D: 0.87, R: 1.11 },
      27: { D: 0.89, R: 1.09 },
      28: { D: 1.11, R: 0.92 },
      29: { D: 1.52, R: 0.57 },
      30: { D: 1.69, R: 0.43 },
      31: { D: 0.88, R: 1.09 },
      32: { D: 0.95, R: 1.04 },
      33: { D: 1.54, R: 0.55 },
      34: { D: 1.07, R: 0.95 },
      35: { D: 1.04, R: 0.97 },
      36: { D: 0.87, R: 1.11 },
      37: { D: 1.77, R: 0.35 },
      38: { D: 0.89, R: 1.09 },
    };

    // --- DOM refs ---
    const svg = document.getElementById("texasMapSVG");
    const tooltip = document.getElementById("tooltip");
    const demInput = document.getElementById("demInput");
    const repInput = document.getElementById("repInput");
    const demLabel = document.getElementById("demLabel");
    const repLabel = document.getElementById("repLabel");
    const resetBtn = document.getElementById("resetBtn");
    const statewideSummary = document.getElementById("statewideSummary");
    const tableBody = document.getElementById("districtTableBody");

    let currentResults = {}; // { id: { dShare, rShare, winner, margin } }

    // --- Map loading (use only polygon features, ignore labels) ---
    async function loadTexasMap() {
      try {
        const response = await fetch("./district-shapes.geojson");
        if (!response.ok) {
          throw new Error("HTTP " + response.status + " when fetching district-shapes.geojson");
        }
        const raw = await response.json();

        // Use ONLY the district polygons for drawing & fitting
        const data = { type: "FeatureCollection", features: raw.features };

        const width = svg.viewBox.baseVal.width || 1000;
        const height = svg.viewBox.baseVal.height || 600;

        const projection = d3.geoMercator().fitSize([width, height], data);
        const pathGen = d3.geoPath().projection(projection);

        while (svg.firstChild) svg.removeChild(svg.firstChild);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        svg.appendChild(g);

        data.features.forEach((feature) => {
          const distId = feature.properties.id;
          if (distId == null) return;

          const d = pathGen(feature);
          if (!d) return;

          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", d);
          path.dataset.districtId = String(distId);

          // Always show boundaries clearly
          path.setAttribute("fill", "none");
          path.setAttribute("stroke", "#e5e7eb");
          path.setAttribute("stroke-width", "1");

          path.classList.add("transition", "duration-150", "cursor-pointer");

          path.addEventListener("mouseover", (e) => showTooltip(e, distId));
          path.addEventListener("mousemove", positionTooltip);
          path.addEventListener("mouseout", hideTooltip);

          g.appendChild(path);
        });

        // Apply colors based on current swing
        recomputeAndRender();
      } catch (err) {
        console.error("Error loading Texas GeoJSON:", err);
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", "50%");
        text.setAttribute("y", "50%");
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#e5e7eb");
        text.setAttribute("font-size", "14");
        text.textContent = "Failed to load district-shapes.geojson. Check path / GitHub Pages.";
        svg.appendChild(text);
      }
    }

    // --- Core swing logic ---
    function recomputeAndRender() {
      let dNat = parseFloat(demInput.value);
      let rNat = parseFloat(repInput.value);

      if (!isFinite(dNat)) dNat = 50;
      if (!isFinite(rNat)) rNat = 50;

      // Normalize so D + R = 100
      const total = dNat + rNat;
      if (total === 0) {
        dNat = 50;
        rNat = 50;
      } else {
        dNat = (dNat / total) * 100;
        rNat = 100 - dNat;
      }

      demInput.value = dNat.toFixed(1);
      repInput.value = rNat.toFixed(1);
      demLabel.textContent = dNat.toFixed(1) + "%";
      repLabel.textContent = rNat.toFixed(1) + "%";

      currentResults = {};

      Object.entries(districtRatios).forEach(([id, dr]) => {
        const scoreD = dr.D * dNat;
        const scoreR = dr.R * rNat;
        const scoreTotal = scoreD + scoreR;

        let dShare = 50;
        let rShare = 50;
        if (scoreTotal > 0) {
          dShare = (scoreD / scoreTotal) * 100;
          rShare = 100 - dShare;
        }

        const winner = dShare >= rShare ? "D" : "R";
        const margin = Math.abs(dShare - rShare);

        currentResults[id] = { dShare, rShare, winner, margin };
      });

      colorMap();
      renderTable();
      renderStatewideSummary();
    }

    function colorMap() {
      const paths = svg.querySelectorAll("path[data-district-id]");
      paths.forEach((path) => {
        const id = path.dataset.districtId;
        const res = currentResults[id];

        if (!res) {
          path.style.fill = "#64748b";
          path.style.opacity = 0.35;
          return;
        }

        const baseColor = res.winner === "D" ? "#2563EB" : "#DC2626";
        const marginClamped = Math.min(res.margin, 40);
        const opacity = 0.3 + 0.7 * (marginClamped / 40);

        path.style.fill = baseColor;
        path.style.opacity = opacity.toString();
      });
    }

    function renderTable() {
      const rows = Object.entries(currentResults)
        .sort((a, b) => Number(a[0]) - Number(b[0]))
        .map(([id, res]) => {
          const winnerLabel =
            res.winner === "D"
              ? '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-500/15 text-blue-200 border border-blue-400/50 text-[0.65rem]">D</span>'
              : '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-red-500/15 text-red-200 border border-red-400/50 text-[0.65rem]">R</span>';

          return `
            <tr class="border-b border-slate-800/70 hover:bg-slate-900/80">
              <td class="px-3 py-1.5 text-slate-100 text-xs">TX-${id}</td>
              <td class="px-3 py-1.5 text-right text-blue-200">${res.dShare.toFixed(1)}%</td>
              <td class="px-3 py-1.5 text-right text-red-200">${res.rShare.toFixed(1)}%</td>
              <td class="px-3 py-1.5 text-center">${winnerLabel}</td>
              <td class="px-3 py-1.5 text-right text-slate-300">${res.margin.toFixed(1)} pts</td>
            </tr>
          `;
        })
        .join("");

      tableBody.innerHTML = rows;
    }

    function renderStatewideSummary() {
      const values = Object.values(currentResults);
      if (!values.length) {
        statewideSummary.textContent = "No district data.";
        return;
      }

      let dSum = 0;
      let rSum = 0;
      values.forEach((res) => {
        dSum += res.dShare;
        rSum += res.rShare;
      });
      const dAvg = dSum / values.length;
      const rAvg = rSum / values.length;

      statewideSummary.textContent = `Average across districts: D ${dAvg.toFixed(
        1
      )}% – R ${rAvg.toFixed(1)}%`;
    }

    // --- Tooltip helpers ---
    function showTooltip(event, distId) {
      const res = currentResults[distId];
      const dr = districtRatios[distId];

      let html = `
        <div class="text-[0.65rem] uppercase tracking-wide text-slate-400">District</div>
        <div class="text-sm font-semibold text-slate-50 mb-1">TX-${distId}</div>
      `;

      if (dr && res) {
        html += `
          <div class="grid grid-cols-2 gap-x-3 gap-y-1 mb-1">
            <div>
              <div class="text-[0.65rem] uppercase text-blue-300/80">D ratio</div>
              <div class="text-xs text-blue-100 font-semibold">${dr.D.toFixed(2)}</div>
            </div>
            <div>
              <div class="text-[0.65rem] uppercase text-red-300/80">R ratio</div>
              <div class="text-xs text-red-100 font-semibold">${dr.R.toFixed(2)}</div>
            </div>
            <div class="mt-1">
              <div class="text-[0.65rem] uppercase text-slate-400/80">D share</div>
              <div class="text-xs text-slate-100">${res.dShare.toFixed(1)}%</div>
            </div>
            <div class="mt-1">
              <div class="text-[0.65rem] uppercase text-slate-400/80">R share</div>
              <div class="text-xs text-slate-100">${res.rShare.toFixed(1)}%</div>
            </div>
          </div>
          <div class="text-[0.65rem] text-slate-400">
            Winner: <span class="${
              res.winner === "D" ? "text-blue-300" : "text-red-300"
            } font-semibold">${res.winner}</span>,
            margin ${res.margin.toFixed(1)} pts
          </div>
        `;
      } else {
        html += `<div class="text-xs text-slate-300">No data for this district.</div>`;
      }

      tooltip.innerHTML = html;
      tooltip.classList.remove("hidden");
      positionTooltip(event);
    }

    function positionTooltip(event) {
      const padding = 12;
      const rect = tooltip.getBoundingClientRect();
      let x = event.clientX + padding;
      let y = event.clientY + padding;
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (x + rect.width + padding > vw) {
        x = event.clientX - rect.width - padding;
      }
      if (y + rect.height + padding > vh) {
        y = event.clientY - rect.height - padding;
      }

      tooltip.style.left = x + "px";
      tooltip.style.top = y + "px";
    }

    function hideTooltip() {
      tooltip.classList.add("hidden");
    }

    // --- Events ---
    demInput.addEventListener("input", recomputeAndRender);
    repInput.addEventListener("input", recomputeAndRender);
    resetBtn.addEventListener("click", () => {
      demInput.value = 50;
      repInput.value = 50;
      recomputeAndRender();
    });

    document.addEventListener("DOMContentLoaded", () => {
      recomputeAndRender();
      loadTexasMap();
    });
  </script>
</body>
</html>
