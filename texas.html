<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Texas Congressional District Swingometer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }
    #tooltip {
      position: fixed;
      z-index: 50;
      pointer-events: none;
      max-width: 260px;
    }
    #tooltip.hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-slate-200 bg-white">
      <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
            Texas Congressional District Swingometer
          </h1>
          <p class="text-xs sm:text-sm text-slate-600 mt-1">
            Adjust statewide D/R support and see how districts tip.
          </p>
        </div>
        <div class="flex items-center gap-3 text-[0.7rem] text-slate-600">
          <span class="inline-flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-blue-600 border border-blue-700"></span>
            Dem lead
          </span>
          <span class="inline-flex items-center gap-1">
            <span class="w-3 h-3 rounded-full bg-red-600 border border-red-700"></span>
            GOP lead
          </span>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
        <!-- Controls + Map -->
        <div class="grid lg:grid-cols-3 gap-6">
          <!-- Controls -->
          <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 space-y-4">
            <h2 class="text-sm font-semibold text-slate-900 tracking-tight">
              Statewide inputs
            </h2>
            <p class="text-xs text-slate-600">
              These are statewide vote shares. Each district’s response is shaped by its D/R ratio.
            </p>

            <div class="space-y-3 mt-2">
              <div>
                <label for="demInput" class="flex justify-between text-xs text-slate-700 mb-1">
                  <span>Democratic vote share</span>
                  <span id="demLabel" class="font-semibold text-blue-700">43.0%</span>
                </label>
                <input
                  id="demInput"
                  type="range"
                  min="0"
                  max="100"
                  step="0.1"
                  value="43"
                  class="w-full"
                />
              </div>

              <div>
                <label for="repInput" class="flex justify-between text-xs text-slate-700 mb-1">
                  <span>Republican vote share</span>
                  <span id="repLabel" class="font-semibold text-red-700">57.0%</span>
                </label>
                <input
                  id="repInput"
                  type="range"
                  min="0"
                  max="100"
                  step="0.1"
                  value="57"
                  class="w-full"
                />
                <p class="mt-1 text-[0.65rem] text-slate-500">
                  Sliders are always normalized so D + R = 100.
                </p>
              </div>
            </div>

            <div class="flex items-center gap-2 mt-3">
              <button
                id="resetBtn"
                class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 hover:bg-slate-200 border border-slate-300"
              >
                Reset to 43–57
              </button>
              <span class="text-[0.7rem] text-slate-600">
                Colors update automatically as you move the sliders.
              </span>
            </div>

            <div class="mt-4 text-xs text-slate-700 space-y-2">
              <div class="text-[0.7rem] uppercase tracking-wide text-slate-500">
                Projected seats
              </div>
              <div id="seatSummary" class="flex items-center gap-3">
                <span
                  id="seatSummaryDem"
                  class="inline-flex items-center px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-300 text-xs font-semibold"
                >
                  D 0
                </span>
                <span
                  id="seatSummaryRep"
                  class="inline-flex items-center px-2 py-1 rounded-full bg-red-50 text-red-700 border border-red-300 text-xs font-semibold"
                >
                  R 0
                </span>
                <span
                  id="seatSummaryTotal"
                  class="text-[0.75rem] text-slate-600"
                >
                  (of 38)
                </span>
              </div>
              <div class="text-[0.7rem] text-slate-600">
                District intensity reflects margin: near ties are very light, blowouts are dark.
              </div>
            </div>
          </section>

          <!-- Map -->
          <section class="lg:col-span-2 bg-white border border-slate-200 rounded-2xl shadow-sm">
            <div class="px-5 pt-4 pb-3 flex items-center justify-between gap-2">
              <div>
                <h2 class="text-sm font-semibold text-slate-900 tracking-tight">
                  Texas districts map
                </h2>
                <p class="text-xs text-slate-600">
                  Hover a district for details.
                </p>
              </div>
            </div>
            <div class="bg-white border-t border-slate-200">
              <div class="aspect-[4/3] w-full flex items-center justify-center">
                <svg
                  id="texasMapSVG"
                  class="w-full h-full"
                  viewBox="0 0 400 400"
                  preserveAspectRatio="xMidYMid meet"
                ></svg>
              </div>
            </div>
          </section>
        </div>

        <!-- District table -->
        <section class="bg-white border border-slate-200 rounded-2xl shadow-sm">
          <div class="px-5 pt-4 pb-3 flex items-center justify-between">
            <div>
              <h2 class="text-sm font-semibold text-slate-900 tracking-tight">
                District-level results
              </h2>
              <p class="text-xs text-slate-600">
                Based on current statewide inputs and fixed district D/R ratios.
              </p>
            </div>
          </div>
          <div class="border-t border-slate-200 max-h-[420px] overflow-y-auto">
            <table class="min-w-full text-xs text-slate-800">
              <thead class="sticky top-0 bg-slate-100 border-b border-slate-200">
                <tr>
                  <th class="px-3 py-2 text-left text-slate-600 font-medium">District</th>
                  <th class="px-3 py-2 text-right text-blue-700 font-medium">D %</th>
                  <th class="px-3 py-2 text-right text-red-700 font-medium">R %</th>
                  <th class="px-3 py-2 text-center text-slate-600 font-medium">Winner</th>
                  <th class="px-3 py-2 text-right text-slate-600 font-medium">Margin</th>
                </tr>
              </thead>
              <tbody id="districtTableBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Tooltip -->
  <div
    id="tooltip"
    class="hidden bg-white border border-slate-300 text-slate-900 text-xs rounded-lg shadow-lg px-3 py-2"
  ></div>

  <script>
    // --- District D/R ratios (your data) ---
    const districtRatios = {
      1:  { D: 0.59, R: 1.35 },
      2:  { D: 0.86, R: 1.12 },
      3:  { D: 0.87, R: 1.09 },
      4:  { D: 0.87, R: 1.11 },
      5:  { D: 0.90, R: 1.09 },
      6:  { D: 0.87, R: 1.11 },
      7:  { D: 1.41, R: 0.65 },
      8:  { D: 0.85, R: 1.13 },
      9:  { D: 0.95, R: 1.05 },
      10: { D: 0.90, R: 1.08 },
      11: { D: 0.75, R: 1.21 },
      12: { D: 0.88, R: 1.10 },
      13: { D: 0.60, R: 1.33 },
      14: { D: 0.85, R: 1.13 },
      15: { D: 1.00, R: 1.01 },
      16: { D: 1.40, R: 0.67 },
      17: { D: 0.90, R: 1.08 },
      18: { D: 1.78, R: 0.36 },
      19: { D: 0.56, R: 1.37 },
      20: { D: 1.49, R: 0.59 },
      21: { D: 0.89, R: 1.09 },
      22: { D: 0.88, R: 1.09 },
      23: { D: 0.99, R: 1.01 },
      24: { D: 0.95, R: 1.04 },
      25: { D: 0.89, R: 1.10 },
      26: { D: 0.87, R: 1.11 },
      27: { D: 0.89, R: 1.09 },
      28: { D: 1.11, R: 0.92 },
      29: { D: 1.52, R: 0.57 },
      30: { D: 1.69, R: 0.43 },
      31: { D: 0.88, R: 1.09 },
      32: { D: 0.95, R: 1.04 },
      33: { D: 1.54, R: 0.55 },
      34: { D: 1.07, R: 0.95 },
      35: { D: 1.04, R: 0.97 },
      36: { D: 0.87, R: 1.11 },
      37: { D: 1.77, R: 0.35 },
      38: { D: 0.89, R: 1.09 },
    };

    // DOM refs
    const svg = document.getElementById("texasMapSVG");
    const tooltip = document.getElementById("tooltip");
    const demInput = document.getElementById("demInput");
    const repInput = document.getElementById("repInput");
    const demLabel = document.getElementById("demLabel");
    const repLabel = document.getElementById("repLabel");
    const resetBtn = document.getElementById("resetBtn");
    const seatSummary = document.getElementById("seatSummary");
    const seatSummaryDem = document.getElementById("seatSummaryDem");
    const seatSummaryRep = document.getElementById("seatSummaryRep");
    const seatSummaryTotal = document.getElementById("seatSummaryTotal");
    const tableBody = document.getElementById("districtTableBody");

    let currentResults = {}; // { id: { dShare, rShare, winner, margin } }

    // ---- Simple lon/lat → SVG projection (no D3) ----
    function computeBounds(features) {
      let minLon = Infinity, minLat = Infinity, maxLon = -Infinity, maxLat = -Infinity;

      for (const f of features) {
        const geom = f.geometry;
        if (!geom) continue;

        if (geom.type === "MultiPolygon") {
          for (const poly of geom.coordinates) {
            for (const ring of poly) {
              for (const coord of ring) {
                const [lon, lat] = coord;
                if (lon < minLon) minLon = lon;
                if (lon > maxLon) maxLon = lon;
                if (lat < minLat) minLat = lat;
                if (lat > maxLat) maxLat = lat;
              }
            }
          }
        } else if (geom.type === "Polygon") {
          for (const ring of geom.coordinates) {
            for (const coord of ring) {
              const [lon, lat] = coord;
              if (lon < minLon) minLon = lon;
              if (lon > maxLon) maxLon = lon;
              if (lat < minLat) minLat = lat;
              if (lat > maxLat) maxLat = lat;
            }
          }
        }
      }

      return { minLon, maxLon, minLat, maxLat };
    }

    function projectPoint(lon, lat, bounds, width, height) {
      const { minLon, maxLon, minLat, maxLat } = bounds;
      const x = ((lon - minLon) / (maxLon - minLon)) * width;
      const y = height - ((lat - minLat) / (maxLat - minLat)) * height;
      return [x, y];
    }

    function geometryToPath(geom, bounds, width, height) {
      let d = "";

      if (geom.type === "MultiPolygon") {
        for (const poly of geom.coordinates) {
          for (const ring of poly) {
            ring.forEach((coord, idx) => {
              const [lon, lat] = coord;
              const [x, y] = projectPoint(lon, lat, bounds, width, height);
              d += (idx === 0 ? "M" : "L") + x + " " + y + " ";
            });
            d += "Z ";
          }
        }
      } else if (geom.type === "Polygon") {
        for (const ring of geom.coordinates) {
          ring.forEach((coord, idx) => {
            const [lon, lat] = coord;
            const [x, y] = projectPoint(lon, lat, bounds, width, height);
            d += (idx === 0 ? "M" : "L") + x + " " + y + " ";
          });
          d += "Z ";
        }
      }

      return d.trim();
    }

    // ---- Map loading ----
    async function loadTexasMap() {
      try {
        const response = await fetch("./district-shapes.geojson");
        if (!response.ok) {
          throw new Error("HTTP " + response.status + " when fetching district-shapes.geojson");
        }
        const raw = await response.json();

        const features = raw.features || [];
        if (!features.length) {
          throw new Error("GeoJSON has no features");
        }

        const width = svg.viewBox.baseVal.width || 400;
        const height = svg.viewBox.baseVal.height || 300;

        const bounds = computeBounds(features);

        while (svg.firstChild) svg.removeChild(svg.firstChild);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        svg.appendChild(g);

        for (const feature of features) {
          const distId = feature.properties && feature.properties.id;
          if (distId == null) continue;
          const geom = feature.geometry;
          if (!geom) continue;

          const pathData = geometryToPath(geom, bounds, width, height);
          if (!pathData) continue;

          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", pathData);
          path.dataset.districtId = String(distId);

          path.setAttribute("stroke", "#94a3b8");
          path.setAttribute("stroke-width", "0.8");
          path.setAttribute("fill", "none");

          path.classList.add("transition", "duration-150", "cursor-pointer");

          path.addEventListener("mouseover", (e) => showTooltip(e, distId));
          path.addEventListener("mousemove", positionTooltip);
          path.addEventListener("mouseout", hideTooltip);

          g.appendChild(path);
        }

        recomputeAndRender();
      } catch (err) {
        console.error("Error loading Texas GeoJSON:", err);
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", "50%");
        text.setAttribute("y", "50%");
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#334155");
        text.setAttribute("font-size", "14");
        text.textContent = "Failed to load district-shapes.geojson. Check path / GitHub Pages.";
        svg.appendChild(text);
      }
    }

    // ---- Swing logic ----
    function recomputeAndRender() {
      let dNat = parseFloat(demInput.value);
      let rNat = parseFloat(repInput.value);

      if (!isFinite(dNat)) dNat = 43;
      if (!isFinite(rNat)) rNat = 57;

      const total = dNat + rNat;
      if (total === 0) {
        dNat = 43;
        rNat = 57;
      } else {
        dNat = (dNat / total) * 100;
        rNat = 100 - dNat;
      }

      demInput.value = dNat.toFixed(1);
      repInput.value = rNat.toFixed(1);
      demLabel.textContent = dNat.toFixed(1) + "%";
      repLabel.textContent = rNat.toFixed(1) + "%";

      currentResults = {};

      Object.entries(districtRatios).forEach(([id, dr]) => {
        const scoreD = dr.D * dNat;
        const scoreR = dr.R * rNat;
        const scoreTotal = scoreD + scoreR;

        let dShare = 50;
        let rShare = 50;
        if (scoreTotal > 0) {
          dShare = (scoreD / scoreTotal) * 100;
          rShare = 100 - dShare;
        }

        const winner = dShare >= rShare ? "D" : "R";
        const margin = Math.abs(dShare - rShare);

        currentResults[id] = { dShare, rShare, winner, margin };
      });

      colorMap();
      renderTable();
      renderSeatSummary();
    }

    function colorMap() {
      const paths = svg.querySelectorAll("path[data-district-id]");
      paths.forEach((path) => {
        const id = path.dataset.districtId;
        const res = currentResults[id];

        if (!res) {
          path.style.fill = "#e2e8f0";
          path.style.opacity = "1";
          return;
        }

        const marginClamped = Math.min(res.margin, 40);
        const t = marginClamped / 40; // 0..1
        const lightness = 95 - t * 45; // 95% -> 50%

        const color =
          res.winner === "D"
            ? `hsl(220, 80%, ${lightness}%)`
            : `hsl(0, 80%, ${lightness}%)`;

        path.style.fill = color;
        path.style.opacity = "1";
      });
    }

    function renderTable() {
      const rows = Object.entries(currentResults)
        .sort((a, b) => Number(a[0]) - Number(b[0]))
        .map(([id, res]) => {
          const winnerLabel =
            res.winner === "D"
              ? '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-300 text-[0.65rem]">D</span>'
              : '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-300 text-[0.65rem]">R</span>';

          return `
            <tr class="border-b border-slate-200 hover:bg-slate-100">
              <td class="px-3 py-1.5 text-slate-900 text-xs">TX-${id}</td>
              <td class="px-3 py-1.5 text-right text-blue-700">${res.dShare.toFixed(1)}%</td>
              <td class="px-3 py-1.5 text-right text-red-700">${res.rShare.toFixed(1)}%</td>
              <td class="px-3 py-1.5 text-center">${winnerLabel}</td>
              <td class="px-3 py-1.5 text-right text-slate-700">${res.margin.toFixed(1)} pts</td>
            </tr>
          `;
        })
        .join("");

      tableBody.innerHTML = rows;
    }

    function renderSeatSummary() {
      const values = Object.values(currentResults);
      if (!values.length) {
        seatSummaryDem.textContent = "D 0";
        seatSummaryRep.textContent = "R 0";
        seatSummaryTotal.textContent = "(of 0)";
        return;
      }

      let dSeats = 0;
      let rSeats = 0;

      values.forEach((res) => {
        if (res.winner === "D") dSeats++;
        else rSeats++;
      });

      seatSummaryDem.textContent = "D " + dSeats;
      seatSummaryRep.textContent = "R " + rSeats;
      seatSummaryTotal.textContent = "(of " + values.length + ")";
    }

    // ---- Tooltip (no ratios shown) ----
    function showTooltip(event, distId) {
      const res = currentResults[distId];

      let html = `
        <div class="text-[0.65rem] uppercase tracking-wide text-slate-500">District</div>
        <div class="text-sm font-semibold text-slate-900 mb-1">TX-${distId}</div>
      `;

      if (res) {
        html += `
          <div class="grid grid-cols-2 gap-x-3 gap-y-1 mb-1">
            <div>
              <div class="text-[0.65rem] uppercase text-blue-600/80">D share</div>
              <div class="text-xs text-slate-900 font-semibold">${res.dShare.toFixed(1)}%</div>
            </div>
            <div>
              <div class="text-[0.65rem] uppercase text-red-600/80">R share</div>
              <div class="text-xs text-slate-900 font-semibold">${res.rShare.toFixed(1)}%</div>
            </div>
          </div>
          <div class="text-[0.65rem] text-slate-600">
            Winner: <span class="${
              res.winner === "D" ? "text-blue-700" : "text-red-700"
            } font-semibold">${res.winner}</span>,
            margin ${res.margin.toFixed(1)} pts
          </div>
        `;
      } else {
        html += `<div class="text-xs text-slate-700">No data for this district.</div>`;
      }

      tooltip.innerHTML = html;
      tooltip.classList.remove("hidden");
      positionTooltip(event);
    }

    function positionTooltip(event) {
      const padding = 12;
      const rect = tooltip.getBoundingClientRect();
      let x = event.clientX + padding;
      let y = event.clientY + padding;
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (x + rect.width + padding > vw) {
        x = event.clientX - rect.width - padding;
      }
      if (y + rect.height + padding > vh) {
        y = event.clientY - rect.height - padding;
      }

      tooltip.style.left = x + "px";
      tooltip.style.top = y + "px";
    }

    function hideTooltip() {
      tooltip.classList.add("hidden");
    }

    // ---- Events ----
    demInput.addEventListener("input", recomputeAndRender);
    repInput.addEventListener("input", recomputeAndRender);
    resetBtn.addEventListener("click", () => {
      demInput.value = 43;
      repInput.value = 57;
      recomputeAndRender();
    });

    document.addEventListener("DOMContentLoaded", () => {
      demInput.value = 43;
      repInput.value = 57;
      recomputeAndRender();
      loadTexasMap();
    });
  </script>
</body>
</html>
